import io.vertx.core.{AbstractVerticle, Vertx}
import io.vertx.ext.web.Router
import io.vertx.ext.web.RoutingContext

/**
 * 1. åŸºäºŽ Vert.x Timer å®žçŽ°çš„é˜²æŠ–å·¥å…·ç±»
 */
class VertxDebouncer(vertx: Vertx, delayMs: Long) {
  // å­˜å‚¨å½“å‰å¾…æ‰§è¡Œçš„å®šæ—¶å™¨IDï¼ˆç”¨äºŽå–æ¶ˆæ—§ä»»åŠ¡ï¼‰
  private var currentTimerId: Option[Long] = None

  /**
   * è§¦å‘é˜²æŠ–ï¼šæ–°è°ƒç”¨ä¼šå–æ¶ˆæ—§ä»»åŠ¡ã€é‡ç½®è®¡æ—¶
   * @param task æœ€ç»ˆè¦æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼ˆä¼šåœ¨ Vert.x ä¸Šä¸‹æ–‡å†…å¼‚æ­¥æ‰§è¡Œï¼‰
   */
  def debounce(task: => Unit): Unit = {
    // ç¬¬ä¸€æ­¥ï¼šå–æ¶ˆä¸Šä¸€æ¬¡æœªæ‰§è¡Œçš„å®šæ—¶å™¨ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå®žçŽ°â€œé‡ç½®è®¡æ—¶â€
    currentTimerId.foreach(timerId => {
      vertx.cancelTimer(timerId)
      println(s"[é˜²æŠ–] å–æ¶ˆæ—§å®šæ—¶å™¨ï¼ˆIDï¼š$timerIdï¼‰ï¼Œé‡ç½®è®¡æ—¶")
    })

    // ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æ–°å®šæ—¶å™¨ï¼Œå»¶è¿ŸåŽæ‰§è¡Œä»»åŠ¡
    val newTimerId = vertx.setTimer(delayMs, _ => {
      println(s"[é˜²æŠ–] å»¶è¿Ÿ ${delayMs}ms åŽæ‰§è¡Œæœ€ç»ˆä»»åŠ¡")
      task // æ‰§è¡Œå®žé™…ä¸šåŠ¡é€»è¾‘
      currentTimerId = None // ä»»åŠ¡æ‰§è¡ŒåŽæ¸…ç©ºå®šæ—¶å™¨IDï¼Œé¿å…æ®‹ç•™
    })

    // ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°å½“å‰å®šæ—¶å™¨IDï¼Œç”¨äºŽä¸‹ä¸€æ¬¡å–æ¶ˆ
    currentTimerId = Some(newTimerId)
    println(s"[é˜²æŠ–] å¯åŠ¨æ–°å®šæ—¶å™¨ï¼ˆIDï¼š$newTimerIdï¼‰ï¼Œç­‰å¾… ${delayMs}ms")
  }

  /**
   * é”€æ¯é˜²æŠ–å™¨ï¼šå–æ¶ˆæ‰€æœ‰æœªæ‰§è¡Œçš„å®šæ—¶å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
   */
  def destroy(): Unit = {
    currentTimerId.foreach { timerId =>
      vertx.cancelTimer(timerId)
      println(s"[é˜²æŠ–] é”€æ¯æ—¶å–æ¶ˆæœªæ‰§è¡Œå®šæ—¶å™¨ï¼ˆIDï¼š$timerIdï¼‰")
    }
  }
}

/**
 * 2. ä¸šåŠ¡ Verticleï¼ˆç›¸å½“äºŽ Controller å±‚ï¼Œå¤„ç† HTTP è¯·æ±‚ï¼‰
 */
class DebounceControllerVerticle extends AbstractVerticle {
  // å£°æ˜Žé˜²æŠ–å™¨ï¼ˆåœ¨ start æ–¹æ³•ä¸­åˆå§‹åŒ–ï¼‰
  private var taskDebouncer: VertxDebouncer = _

  override def start(): Unit = {
    // åˆå§‹åŒ–é˜²æŠ–å™¨ï¼šä¼ å…¥å½“å‰ Vert.x å®žä¾‹ + é˜²æŠ–å»¶è¿Ÿï¼ˆè¿™é‡Œè®¾ä¸º 1000ms = 1ç§’ï¼‰
    taskDebouncer = new VertxDebouncer(vertx, 1000)

    // é…ç½® HTTP è·¯ç”±
    val router = Router.router(vertx)
    // å®šä¹‰æŽ¥å£ï¼š/api/doTaskï¼ˆGET è¯·æ±‚ï¼Œæ¯æ¬¡è°ƒç”¨è§¦å‘é˜²æŠ–ï¼‰
    router.get("/api/doTask").handler(handleTaskRequest)

    // å¯åŠ¨ HTTP æœåŠ¡ï¼ˆç›‘å¬ 8080 ç«¯å£ï¼‰
    vertx.createHttpServer()
      .requestHandler(router) // å°†è·¯ç”±ç»‘å®šåˆ° HTTP æœåŠ¡
      .listen(8080)
      .onSuccess(_ => println("âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼å¯è®¿é—®ï¼šhttp://localhost:8080/api/doTask"))
      .onFailure(e => println(s"âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼š${e.getMessage}"))
  }

  /**
   * HTTP æŽ¥å£å¤„ç†é€»è¾‘ï¼šæŽ¥æ”¶è¯·æ±‚å¹¶è§¦å‘é˜²æŠ–
   */
  private val handleTaskRequest: RoutingContext => Unit = ctx => {
    // 1. èŽ·å–è¯·æ±‚å‚æ•°ï¼ˆç¤ºä¾‹ï¼šèŽ·å– url ä¸­çš„ "taskId" å‚æ•°ï¼‰
    val taskId = ctx.request().getParam("taskId") match {
      case null => "é»˜è®¤ä»»åŠ¡" // æ— å‚æ•°æ—¶ç”¨é»˜è®¤å€¼
      case id => s"ä»»åŠ¡$id"
    }

    // 2. è§¦å‘é˜²æŠ–ï¼šå®žé™…ä¸šåŠ¡é€»è¾‘å†™åœ¨ debounce çš„å‚æ•°ä¸­
    taskDebouncer.debounce {
      // è¿™é‡Œæ˜¯â€œæœ€ç»ˆè¦æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘â€ï¼ˆä»…æœ€åŽä¸€æ¬¡è§¦å‘ä¼šæ‰§è¡Œï¼‰
      println(s"ðŸ“Œ æ‰§è¡Œã€$taskIdã€‘çš„æ ¸å¿ƒä¸šåŠ¡ï¼šæ¯”å¦‚æŸ¥è¯¢æ•°æ®åº“ã€è°ƒç”¨ç¬¬ä¸‰æ–¹æŽ¥å£ç­‰")
    }

    // 3. ç«‹å³è¿”å›žå“åº”ç»™å‰ç«¯ï¼ˆä¸ç­‰å¾…é˜²æŠ–ä»»åŠ¡æ‰§è¡Œï¼‰
    ctx.response()
      .setStatusCode(200) // æˆåŠŸçŠ¶æ€ç 
      .putHeader("Content-Type", "text/plain;charset=utf-8")
      .end(s"è¯·æ±‚å·²æŽ¥æ”¶ï¼ã€$taskIdã€‘å°†åœ¨ 1ç§’ åŽæ‰§è¡Œï¼ˆè‹¥1ç§’å†…æ— æ–°è¯·æ±‚ï¼‰")
  }

  /**
   * Verticle åœæ­¢æ—¶ï¼šé”€æ¯é˜²æŠ–å™¨ï¼Œæ¸…ç†èµ„æº
   */
  override def stop(): Unit = {
    taskDebouncer.destroy()
    println("ðŸ”š æœåŠ¡åœæ­¢ï¼Œé˜²æŠ–å™¨å·²é”€æ¯ï¼Œèµ„æºæ¸…ç†å®Œæˆ")
  }
}

/**
 * 3. ç¨‹åºå…¥å£ï¼ˆå¯åŠ¨ Vert.x å¹¶éƒ¨ç½² Verticleï¼‰
 */
object DebounceExampleMain {
  def main(args: Array[String]): Unit = {
    // åˆ›å»º Vert.x å®žä¾‹
    val vertx = Vertx.vertx()

    // éƒ¨ç½²ä¸šåŠ¡ Verticleï¼ˆDebounceControllerVerticleï¼‰
    vertx.deployVerticle(new DebounceControllerVerticle())
      .onFailure(e => println(s"Verticle éƒ¨ç½²å¤±è´¥ï¼š${e.getMessage}"))
  }
}
